<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="p-4">
  <div class="container">
    <!-- Global Flash Message (success/error) -->
    {% if flash_message %}
    <div class="alert alert-info alert-dismissible fade show" role="alert">
      {{ flash_message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="fw-bold">Attendance Report</h2>
      <div>
        <a href="/teacher_records" id="teacherRecordsLink" class="btn btn-outline-primary me-2">Meeting Dashboard</a>
        <a href="/logout" class="btn btn-outline-danger">Logout</a>
      </div>
    </div>

    <!-- Filters: Date & Faculty -->
    <div class="mb-4">
      <form method="get" class="d-flex gap-3 align-items-end flex-wrap">
        <div>
          <label for="date" class="form-label">Select Date</label>
          <input
            type="date"
            id="date"
            name="date"
            value="{{ selected_date | replace('_', '-') }}"
            class="form-control"
          />
        </div>
        <div>
          <label for="faculty_filter" class="form-label">Select Faculty</label>
          <select id="faculty_filter" name="faculty" class="form-select">
            <option value="" {% if not selected_faculty %}selected{% endif %}>All Faculties</option>
            {% for faculty in faculties %}
            <option value="{{ faculty }}" {% if selected_faculty == faculty %}selected{% endif %}>{{ faculty }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="room_filter" class="form-label">Select Room</label>
          <select id="room_filter" name="room_id" class="form-select">
            <option value="" {% if not selected_room_id %}selected{% endif %}>All Rooms</option>
            {% for room in rooms %}
            <option value="{{ room.id }}" {% if selected_room_id|int == room.id %}selected{% endif %}>
              {{ room.name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="meeting_filter" class="form-label">Select Meeting</label>
          <select id="meeting_filter" name="meeting_id" class="form-select">
            <option value="" {% if not selected_meeting_id %}selected{% endif %}>All Meetings</option>
            {% for meeting in meetings %}
            <option value="{{ meeting.id }}" {% if selected_meeting_id|int == meeting.id %}selected{% endif %}>
              {{ meeting.title }}
            </option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="btn btn-primary mb-1">Filter</button>
        <a href="/download_csv?date={{ selected_date }}{% if selected_faculty %}&faculty={{ selected_faculty }}{% endif %}{% if selected_room_id %}&room_id={{ selected_room_id }}{% endif %}{% if selected_meeting_id %}&meeting_id={{ selected_meeting_id }}{% endif %}" class="btn btn-success mb-1">
          Download Attendance CSV
        </a>
      </form>
    </div>

    <!-- Delete Registered Student -->
    <div class="mb-4">
      <form
        id="deleteUserForm"
        class="d-flex gap-3 align-items-end"
      >
        <div>
          <label for="email" class="form-label">Delete Registered Student (By Email)</label>
          <input
            type="email"
            id="email"
            name="email"
            class="form-control"
            placeholder="Enter student email"
            required
          />
        </div>
        <button type="submit" class="btn btn-danger mb-1">Delete Student</button>
      </form>
    </div>

    <!-- Faculty Attendance Sections -->
    {% for faculty, data in attendance_by_faculty.items() %}
    <div class="mb-5">
      <h4 class="fw-bold mb-3">{{ faculty }}</h4>

      <!-- Summary Counts -->
      <div class="mb-3">
        <div class="row">
          <div class="col-md-4">
            <div class="alert alert-success">Present: {{ data.present | length }}</div>
          </div>
          <div class="col-md-4">
            <div class="alert alert-danger">Absent: {{ data.absent | length }}</div>
          </div>
          <div class="col-md-4">
            <div class="alert alert-info">Total: {{ data.present | length + data.absent | length }}</div>
          </div>
        </div>
      </div>

      <!-- Tabs for Present, Absent and Total Lists -->
      <ul class="nav nav-tabs mb-3" id="tabs-{{ loop.index }}" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="present-tab-{{ loop.index }}"
            data-bs-toggle="tab"
            data-bs-target="#present-{{ loop.index }}"
            type="button"
            role="tab"
          >
            Present
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="absent-tab-{{ loop.index }}"
            data-bs-toggle="tab"
            data-bs-target="#absent-{{ loop.index }}"
            type="button"
            role="tab"
          >
            Absent
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="total-tab-{{ loop.index }}"
            data-bs-toggle="tab"
            data-bs-target="#total-{{ loop.index }}"
            type="button"
            role="tab"
          >
            Total
          </button>
        </li>
      </ul>

      <div class="tab-content" id="tabsContent-{{ loop.index }}">
        <!-- Present Tab -->
        <div class="tab-pane fade show active" id="present-{{ loop.index }}" role="tabpanel">
          <table class="table table-bordered table-striped">
            <thead class="table-dark">
              <tr>
                <th>Photo</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Role</th>
                <th>Faculty</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for user in data.present %}
              <tr>
                <td>
                  {% if user.photo %}
                  <img
                    src="data:image/jpeg;base64,{{ user.photo | b64encode }}"
                    alt="photo"
                    width="80"
                    height="80"
                    style="object-fit: cover; border-radius: 8px;"
                  />
                  {% else %}
                  <span class="text-muted">No photo</span>
                  {% endif %}
                </td>
                <td>{{ user.fname }}</td>
                <td>{{ user.lname }}</td>
                <td>{{ user.role }}</td>
                <td>{{ user.faculty }}</td>
                <td><span class="badge bg-success">Present</span></td>
              </tr>
              {% endfor %}
              {% if data.present | length == 0 %}
              <tr><td colspan="5" class="text-center text-muted">No present users in this faculty.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        <!-- Absent Tab -->
        <div class="tab-pane fade" id="absent-{{ loop.index }}" role="tabpanel">
          <table class="table table-bordered table-striped">
            <thead class="table-dark">
              <tr>
                <th>Photo</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Role</th>
                <th>Faculty</th>
                <th>Status</th>
                <!-- Removed Action column -->
              </tr>
            </thead>
            <tbody>
              {% for user in data.absent %}
              <tr>
                <td>
                  {% if user.photo %}
                  <img
                    src="data:image/jpeg;base64,{{ user.photo | b64encode }}"
                    alt="photo"
                    width="80"
                    height="80"
                    style="object-fit: cover; border-radius: 8px;"
                  />
                  {% else %}
                  <span class="text-muted">No photo</span>
                  {% endif %}
                </td>
                <td>{{ user.fname }}</td>
                <td>{{ user.lname }}</td>
                <td>{{ user.role }}</td>
                <td>{{ user.faculty }}</td>
                <td><span class="badge bg-danger">Absent</span></td>
              </tr>
              {% endfor %}
              {% if data.absent | length == 0 %}
              <tr><td colspan="6" class="text-center text-muted">No absent users in this faculty.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        <!-- Total Tab -->
        <div class="tab-pane fade" id="total-{{ loop.index }}" role="tabpanel">
          <table class="table table-bordered table-striped">
            <thead class="table-dark">
              <tr>
                <th>Photo</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Role</th>
                <th>Faculty</th>
                <th>Email</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for user in data.present + data.absent %}
              <tr>
                <td>
                  {% if user.photo %}
                  <img
                    src="data:image/jpeg;base64,{{ user.photo | b64encode }}"
                    alt="photo"
                    width="80"
                    height="80"
                    style="object-fit: cover; border-radius: 8px;"
                  />
                  {% else %}
                  <span class="text-muted">No photo</span>
                  {% endif %}
                </td>
                <td>{{ user.fname }}</td>
                <td>{{ user.lname }}</td>
                <td>{{ user.role }}</td>
                <td>{{ user.faculty }}</td>
                <td>{{ user.email }}</td>
                <td>
                  <!-- Edit Button Trigger -->
                  <button
                    type="button"
                    class="btn btn-warning btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#editUserModal-{{ user.email | replace('@', '_') }}"
                  >
                    Edit
                  </button>
                </td>
              </tr>

              <!-- Modal -->
              <div
                class="modal fade"
                id="editUserModal-{{ user.email | replace('@', '_') }}"
                tabindex="-1"
                aria-labelledby="editUserModalLabel-{{ user.email | replace('@', '_') }}"
                aria-hidden="true"
              >
                <div class="modal-dialog">
                  <div class="modal-content">
                    <form  id="editUserForm-{{ user.email | replace('@', '_') }}" method="POST" action="/student_records/edit_user/{{ user.email }}" enctype="multipart/form-data" onsubmit="return false;">
                      <div class="modal-header">
                        <h5 class="modal-title" id="editUserModalLabel-{{ user.email | replace('@', '_') }}">Edit User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <!-- Modal-specific flash message -->
                        {% if modal_flash_message and modal_flash_email == user.email %}
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                          {{ modal_flash_message }}
                          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endif %}
                        
                        <div class="mb-3">
                          <label class="form-label">First Name</label>
                          <input type="text" class="form-control" name="fname" value="{{ user.fname }}" required />
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Last Name</label>
                          <input type="text" class="form-control" name="lname" value="{{ user.lname }}" required />
                        </div>
                        <div class="mb-3">
                          <label class="form-label">New Password (leave blank to keep current)</label>
                          <input type="password" class="form-control" name="password" />
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Update Photo (optional)</label>
                          <input type="file" class="form-control" name="photo_file" accept="image/*" />
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              {% endfor %}
              {% if (data.present | length + data.absent | length) == 0 %}
              <tr><td colspan="7" class="text-center text-muted">No users in this faculty.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
   <!-- Your detached custom JS -->
  <script src="{{ url_for('static', filename='js/student_records.js') }}"></script>
</body>
</html>
